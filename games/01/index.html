<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tap 10s Challenge</title>
  <style>
    html,body{margin:0; height:100%; background:#111; color:#fff; font-family:system-ui, sans-serif;}
    #wrap{display:flex; flex-direction:column; height:100%;}
    #topbar{padding:10px 12px; display:flex; gap:12px; align-items:baseline;}
    #topbar b{font-size:18px;}
    #topbar span{opacity:.85;}
    canvas{flex:1; touch-action:manipulation; display:block; width:100%; height:100%;}
    #hint{padding:10px 12px; font-size:12px; opacity:.8;}
  </style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <b>タップ10秒</b>
    <span id="state">STARTを押してね</span>
  </div>
  <canvas id="c"></canvas>
  <div id="hint">操作：画面をタップ。もう一度長押しでリトライ。</div>
</div>

<script>
(() => {
  // ===== Canvas 基本セットアップ（高DPI対応） =====
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  function resize() {
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // 以後はCSSピクセルで描画
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ===== ゲーム状態 =====
  const UI = {
    state: document.getElementById('state')
  };

  let phase = "idle"; // idle -> playing -> result
  let score = 0;
  let startTime = 0;
  const DURATION = 10_000; // 10秒

  // タップ対象（大きな丸ボタン）
  const btn = { x: 0, y: 0, r: 0 };

  function setButtonLayout() {
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    btn.x = w / 2;
    btn.y = h * 0.52;
    btn.r = Math.min(w, h) * 0.22;
  }
  setButtonLayout();
  window.addEventListener('resize', setButtonLayout, {passive:true});

  // ===== 入力（タップ/クリック統一） =====
  function getPos(ev) {
    const rect = canvas.getBoundingClientRect();
    const x = (ev.clientX - rect.left);
    const y = (ev.clientY - rect.top);
    return {x,y};
  }

  function hitButton(p) {
    const dx = p.x - btn.x;
    const dy = p.y - btn.y;
    return (dx*dx + dy*dy) <= (btn.r*btn.r);
  }

  function startGame() {
    phase = "playing";
    score = 0;
    startTime = performance.now();
    UI.state.textContent = "タップ！タップ！";
  }

  function finishGame() {
    phase = "result";
    UI.state.textContent = `結果：${score} 回（長押しでリトライ）`;
  }

  function onTap(ev) {
    ev.preventDefault();
    const p = getPos(ev);
    if (phase === "idle") {
      if (hitButton(p)) startGame();
      return;
    }
    if (phase === "playing") {
      if (hitButton(p)) score++;
      return;
    }
    if (phase === "result") {
      // result中は短タップは無視（長押しでやり直し）
      return;
    }
  }

  // 長押しでリトライ（スマホで便利）
  let pressTimer = null;
  function onDown(ev) {
    ev.preventDefault();
    if (phase !== "result") return;
    pressTimer = setTimeout(() => {
      phase = "idle";
      UI.state.textContent = "STARTを押してね";
    }, 450);
  }
  function onUp(ev) {
    ev.preventDefault();
    if (pressTimer) clearTimeout(pressTimer);
    pressTimer = null;
  }

  canvas.addEventListener('pointerdown', onDown, {passive:false});
  canvas.addEventListener('pointerup', onUp, {passive:false});
  canvas.addEventListener('pointercancel', onUp, {passive:false});
  canvas.addEventListener('pointermove', (e)=>e.preventDefault(), {passive:false});
  canvas.addEventListener('pointerup', onTap, {passive:false}); // pointerupでタップ判定

  // ===== 描画 =====
  function draw(now) {
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    // 背景
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "#111";
    ctx.fillRect(0,0,w,h);

    // 進行タイマー
    let tLeft = DURATION;
    if (phase === "playing") {
      const t = now - startTime;
      tLeft = Math.max(0, DURATION - t);
      if (tLeft === 0) finishGame();
    }

    // 上部HUD
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.font = "16px system-ui";
    ctx.fillText(`SCORE: ${score}`, 14, 26);

    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.fillText(`TIME: ${(tLeft/1000).toFixed(1)}s`, 14, 48);

    // ボタン
    const grad = ctx.createRadialGradient(btn.x, btn.y, btn.r*0.2, btn.x, btn.y, btn.r);
    grad.addColorStop(0, phase==="playing" ? "#ffe27a" : "#9be7ff");
    grad.addColorStop(1, "#2b2b2b");

    ctx.beginPath();
    ctx.arc(btn.x, btn.y, btn.r, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();

    // ラベル文字
    ctx.fillStyle = "#000";
    ctx.font = `bold ${Math.max(18, Math.floor(btn.r*0.28))}px system-ui`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const label =
      phase === "idle" ? "START" :
      phase === "playing" ? "TAP!" :
      "DONE";

    ctx.fillText(label, btn.x, btn.y);

    // ガイド
    ctx.textAlign = "center";
    ctx.textBaseline = "alphabetic";
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.font = "13px system-ui";
    if (phase === "idle") ctx.fillText("丸を押してスタート", w/2, h*0.86);
    if (phase === "playing") ctx.fillText("丸だけを連打！", w/2, h*0.86);
    if (phase === "result") ctx.fillText("長押しでリトライ", w/2, h*0.86);

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();
</script>
</body>
</html>
