<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>10s Omae Challenge</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #111;
      color: #fff;
      font-family: system-ui, sans-serif;

      overflow: hidden;      /* ★スクロール禁止 */
      overscroll-behavior: none; /* ★引っ張りスクロール抑止 */
      touch-action: none;    /* ★ページ側のジェスチャ抑止 */
    }
    #wrap{display:flex; flex-direction:column; height:100vh;}
    #topbar{padding:10px 12px; display:flex; gap:12px; align-items:baseline;}
    #topbar b{font-size:18px;}
    #topbar span{opacity:.85;}
    canvas{flex:1; touch-action:none; display:block; width:100%;}
    #hint{
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    padding:10px 12px;
    font-size:12px;
    opacity:.85;
    background: rgba(0,0,0,0.55);
    border-radius: 12px;
    pointer-events: none; /* タップ操作の邪魔をしない */
    display: none; /*とりあえず表示なしにする*/
    }
    
  </style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <b>10秒おまえチャレンジ</b>
    <span id="state">あひるを押してね</span>
  </div>
  <canvas id="c"></canvas>
 <div id="hint">操作：画面をタップ。もう一度長押しでリトライ。</div>　<!--/*とりあえず表示なしにする-->
</div>

<script>
(() => {
  // ===== Canvas 基本セットアップ（高DPI対応） =====
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  function resize() {
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // 以後はCSSピクセルで描画
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ===== 画像ロード（キャッシュ対策込み） =====
const buttonImg = new Image();
let buttonImgReady = false;

function markReady() {
  if (!buttonImgReady) {
    buttonImgReady = true;
    console.log("button image ready:", buttonImg.src);
  }
}

buttonImg.onload = markReady;
buttonImg.onerror = () => console.warn("画像が読めない:", buttonImg.src);

// onload より先に src を入れない！
buttonImg.src = new URL("./img/ahiru.png", location.href).href;

// キャッシュで onload が飛ばない場合の保険
if (buttonImg.complete && buttonImg.naturalWidth > 0) {
  markReady();
}


  // ===== ゲーム状態 =====
  const UI = {
    state: document.getElementById('state')
  };

  let phase = "idle"; // idle -> playing -> result
  let score = 0;
  let startTime = 0;
  const DURATION = 10_000; // 10秒

  let isPressed = false;
  let pressOnButton = false;
  const PRESS_SCALE = 0.94; // 押し込み量（0.90〜0.97くらいで好み調整）


  // ===== 評価のしきい値（ここだけ触れば調整できる） =====
  const SCORE_TIER = {
  great: 55, // これ以上なら最高 やるじゃん
  good: 25,  // これ以上なら良い ふ～ん
  // それ未満はもう少し　やれよ
  };

  let resultComment = "";

  function commentForScore(s) {
    if (s >= SCORE_TIER.great) return "やるじゃん";
    if (s >= SCORE_TIER.good)  return "ふ～ん";
    return "やれよ";
  }


  // タップ対象（大きな丸ボタン）
  const btn = { x: 0, y: 0, r: 0 };

  function setButtonLayout() {
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    btn.x = w / 2;
    btn.y = h * 0.52;
    btn.r = Math.min(w, h) * 0.22;
  }
  setButtonLayout();
  window.addEventListener('resize', setButtonLayout, {passive:true});

  // ===== 入力（タップ/クリック統一） =====
  function getPos(ev) {
    const rect = canvas.getBoundingClientRect();
    const x = (ev.clientX - rect.left);
    const y = (ev.clientY - rect.top);
    return {x,y};
  }

  function hitButton(p) {
    const dx = p.x - btn.x;
    const dy = p.y - btn.y;
    return (dx*dx + dy*dy) <= (btn.r*btn.r);
  }

  function startGame() {
    phase = "playing";
    score = 0;
    startTime = performance.now();
    UI.state.textContent = "おまえ！おまえ！";
  }

  function finishGame() {
    phase = "result";
    resultComment = commentForScore(score);
    UI.state.textContent = `ありがとう`;
//    UI.state.textContent = `結果：${score} 回（長押しでもういちどおまえ）`;
  }

  function onTap(ev) {
    ev.preventDefault();
    const p = getPos(ev);
    if (phase === "idle") {
      if (hitButton(p)) startGame();
      return;
    }
    if (phase === "playing") {
      if (hitButton(p)) score++;
      return;
    }
    if (phase === "result") {
      // result中は短タップは無視（長押しでやり直し）
      return;
    }
  }

  // 長押しでリトライ（スマホで便利）
  let pressTimer = null;
  function onDown(ev) {
    ev.preventDefault();

    const p = getPos(ev);
    pressOnButton = hitButton(p);   // ★押した場所がボタン内か
    isPressed = pressOnButton;      // ★ボタン内のときだけ押し込みON
 
    if (phase !== "result") return;
    pressTimer = setTimeout(() => {
      phase = "idle";
      UI.state.textContent = "あひるをたたこう";
    }, 450);
  }
  function onUp(ev) {
    ev.preventDefault();
    isPressed = false;
    pressOnButton = false;
    if (pressTimer) clearTimeout(pressTimer);
    pressTimer = null;
  }

  canvas.addEventListener('pointerdown', onDown, {passive:false});
  canvas.addEventListener('pointerup', onUp, {passive:false});
  canvas.addEventListener('pointercancel', onUp, {passive:false});
  canvas.addEventListener('pointermove', (e)=>e.preventDefault(), {passive:false});
  canvas.addEventListener('pointerup', onTap, {passive:false}); // pointerupでタップ判定

  // ===== 描画 =====
  function draw(now) {
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const w = canvas.width / dpr;   // ← 内部描画と一致する幅
    const h = canvas.height / dpr;  // ← 内部描画と一致する高さ


    const label =
      phase === "idle" ? "やる？" :
      phase === "playing" ? "おまえ!" :
      "おわり";


    // 背景
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "#111";
    ctx.fillRect(0,0,w,h);

    // 進行タイマー
    let tLeft = DURATION;
    if (phase === "playing") {
      const t = now - startTime;
      tLeft = Math.max(0, DURATION - t);
      if (tLeft === 0) finishGame();
    }

    // 上部HUD
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.font = "16px system-ui";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    
    ctx.fillText(`SCORE: ${score}`, 14, 26);

    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.fillText(`TIME: ${(tLeft/1000).toFixed(1)}s`, 14, 48);
    ctx.restore();

    // ボタン
    // ===== ボタン（四角画像：透過PNGそのまま） =====
    const size = btn.r * 2;                 // 既存の半径(btn.r)を流用してサイズ決定
    const x = btn.x - size / 2;
    const y = btn.y - size / 2;

    // 画像が未ロードなら仮表示
    const scale = pressOnButton ? PRESS_SCALE : 1.0;
    const drawSize = size * scale;
    const dx = btn.x - drawSize / 2;
    const dy = btn.y - drawSize / 2;

    if (!buttonImgReady) {
      ctx.fillStyle = "#2b2b2b";
      ctx.fillRect(dx, dy, drawSize, drawSize);
    } else {
      ctx.drawImage(buttonImg, dx, dy, drawSize, drawSize);
    }

    if (isPressed) {
      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(dx, dy, drawSize, drawSize);
    }

    // ===== 結果オーバーレイ（写真の上にだけ表示） =====
    if (phase === "result") {
      // 画像ボタンの四角の範囲（今の描画と同じ x,y,size を使う）
      // x, y, size がこのスコープに無い場合は同じ計算をここで再定義してOK
     const pad = size * 0.06;

     // 下側に2行（スコア＋コメント）
      const boxH = size * 0.34;
      const boxY = y + size - boxH;

      // 半透明の黒背景（文字が読めるように）
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(x, boxY, size, boxH);

      // スコア
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      ctx.font = `bold ${Math.max(16, Math.floor(size * 0.13))}px system-ui`;
      ctx.fillText(`SCORE: ${score}`, btn.x, boxY + boxH * 0.35);

      // コメント
      ctx.font = `${Math.max(14, Math.floor(size * 0.10))}px system-ui`;
      ctx.fillText(resultComment, btn.x, boxY + boxH * 0.72); 
    }


    // // 視認性のために枠（任意）
    // ctx.lineWidth = 3;
    // ctx.strokeStyle = "rgba(255,255,255,0.25)";
    // ctx.strokeRect(x, y, size, size);

    // // ラベル文字を画像の上に出す（不要ならこのブロック消してOK）
    // ctx.fillStyle = "rgba(0,0,0,0.55)";
    // ctx.fillRect(x, y + size * 0.68, size, size * 0.32);
    // ctx.fillStyle = "#fff";
    // ctx.font = `bold ${Math.max(16, Math.floor(size * 0.12))}px system-ui`;
    // ctx.textAlign = "center";
    // ctx.textBaseline = "middle";
    // ctx.fillText(label, btn.x, y + size * 0.84);


    // ラベル文字
    ctx.fillStyle = "#000";
    ctx.font = `bold ${Math.max(18, Math.floor(btn.r*0.28))}px system-ui`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    ctx.fillText(label, btn.x, btn.y);

    // ガイド
    ctx.textAlign = "center";
    ctx.textBaseline = "alphabetic";
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.font = "13px system-ui";
    if (phase === "idle") ctx.fillText("あひるを叩いてスタート", w/2, h*0.86);
    if (phase === "playing") ctx.fillText("あひるを連打！", w/2, h*0.86);
    if (phase === "result") ctx.fillText("長押しでリトライ", w/2, h*0.86);

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();
</script>
</body>
</html>
